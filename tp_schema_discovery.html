<!DOCTYPE html>
<html>
<head>
  <title>TP Entity Discovery</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: #e0e0e0;
    }

    .header {
      background: #0f171c;
      color: white;
      padding: 20px 40px;
      border-bottom: 2px solid #00d9ff;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    #loading {
      background: #ffe9a2;
      color: #000;
      padding: 16px;
      text-align: center;
      font-weight: 500;
    }

    .container {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .info-box {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.4);
      color: #60a5fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .info-box strong {
      color: #93c5fd;
    }

    .section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section h2 {
      color: #00d9ff;
      margin-top: 0;
      font-size: 20px;
      font-weight: 600;
      border-bottom: 2px solid rgba(0, 217, 255, 0.3);
      padding-bottom: 12px;
      margin-bottom: 20px;
    }

    .button {
      background: linear-gradient(135deg, #00d9ff 0%, #b084ff 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 12px;
      transition: transform 0.2s;
    }

    .button:hover {
      transform: translateY(-2px);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button.secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .entity-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      border-left: 4px solid #00d9ff;
      transition: all 0.2s;
    }

    .entity-card:hover {
      background: rgba(0, 217, 255, 0.05);
      border-left-color: #b084ff;
    }

    .entity-card h3 {
      color: #00d9ff;
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600;
    }

    .entity-stats {
      display: flex;
      gap: 20px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .stat {
      background: rgba(255, 255, 255, 0.05);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
    }

    .stat-label {
      color: #9ca3af;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      color: #00d9ff;
      font-weight: 600;
      font-size: 16px;
    }

    .field-list {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .field-category {
      margin-bottom: 16px;
    }

    .field-category h4 {
      color: #b084ff;
      font-size: 14px;
      margin: 0 0 8px 0;
      font-weight: 600;
    }

    .field-tag {
      display: inline-block;
      background: rgba(176, 132, 255, 0.2);
      color: #b084ff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      margin: 4px 4px 4px 0;
      border: 1px solid rgba(176, 132, 255, 0.3);
    }

    .field-tag.basic { background: rgba(0, 217, 255, 0.2); color: #00d9ff; border-color: rgba(0, 217, 255, 0.3); }
    .field-tag.tag { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border-color: rgba(251, 191, 36, 0.3); }
    .field-tag.property { background: rgba(74, 222, 128, 0.2); color: #4ade80; border-color: rgba(74, 222, 128, 0.3); }
    .field-tag.namespace { background: rgba(168, 85, 247, 0.2); color: #a855f7; border-color: rgba(168, 85, 247, 0.3); }

    .progress {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }

    .progress-bar {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      background: linear-gradient(90deg, #00d9ff, #b084ff);
      height: 100%;
      transition: width 0.3s;
    }

    .query-operations {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .query-operations h4 {
      color: #00d9ff;
      margin: 0 0 12px 0;
      font-size: 16px;
    }

    .operation {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .success {
      color: #4ade80;
      font-weight: 600;
    }

    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #f87171;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîç TP Entity Discovery</h1>
  </div>

  <div id="loading">‚è≥ Discovering available query operations and entity types...</div>

  <div class="container">
    <div class="info-box">
      <strong>üìã What this does:</strong><br><br>
      This report automatically discovers:
      <ul style="margin: 8px 0 0 20px;">
        <li><strong>Query Operations:</strong> Available GraphQL query operations (entityQuery, aggregateQuery, etc.)</li>
        <li><strong>Entity Types:</strong> All TP entity types with actual data</li>
        <li><strong>Sample Data:</strong> Real field names, values, tags, properties, and namespaces</li>
      </ul>
      <br>
      <strong>üí° One-Click Process:</strong> No manual clicking required! Everything is discovered automatically and exported as JSON for the Report Builder.
    </div>

    <div class="section">
      <h2>Actions</h2>
      <button id="downloadBtn" class="button" disabled>Download Complete Schema JSON</button>
      <button id="copyBtn" class="button secondary" disabled>Copy to Clipboard</button>
    </div>

    <div id="queryOperations" class="section" style="display: none;">
      <h2>Available Query Operations</h2>
      <div id="operationsList"></div>
    </div>

    <div id="discoveryProgress" class="section" style="display: none;">
      <h2>Entity Type Discovery Progress</h2>
      <div class="progress">
        <div><span id="progressText">Checking entity types...</span></div>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div id="results" class="section" style="display: none;">
      <h2>Discovered Entity Types (<span id="entityCount">0</span>)</h2>
      <div id="entityList"></div>
    </div>
  </div>

  <script>
    var serviceUrl = '';
    var bearerToken = '';
    var discoveredSchema = {
      queryOperations: [],
      entityTypes: [],
      discoveryDate: new Date().toISOString()
    };

    // Common TP entity types to check
    // All types are included in schema even if no data exists
    const COMMON_ENTITY_TYPES = [
      { name: "Tanzu.Portfolio.Repository", description: "Portfolio repositories (apps, code repos)" },
      { name: "Tanzu.Portfolio.Application", description: "Portfolio applications" },
      { name: "Tanzu.Portfolio.BusinessApp", description: "Portfolio business applications" },
      { name: "Tanzu.Portfolio.Space", description: "Portfolio spaces" },
      { name: "Tanzu.TAP.Workload", description: "TAP workloads" },
      { name: "Tanzu.TAP.Deliverable", description: "TAP deliverables" },
      { name: "Tanzu.TAS.Application", description: "TAS applications" },
      { name: "Tanzu.TAS.Space", description: "TAS spaces" },
      { name: "Tanzu.TAS.Organization", description: "TAS organizations" },
      { name: "Tanzu.TKG.Cluster", description: "TKG clusters" },
      { name: "Tanzu.VM", description: "Virtual machines" },
      { name: "Tanzu.Container", description: "Containers" },
      { name: "Tanzu.Database", description: "Databases" }
    ];

    async function fetchGraphQL(query, variables) {
      const response = await fetch(serviceUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': bearerToken
        },
        body: JSON.stringify({ query, variables })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      if (result.errors) {
        throw new Error(result.errors[0].message);
      }

      return result.data;
    }

    async function discoverQueryOperations() {
      console.log('Discovering query operations...');

      // Simplified introspection query to avoid depth issues
      const query = `
        query {
          __schema {
            queryType {
              fields {
                name
                description
                args {
                  name
                  description
                  type {
                    name
                    kind
                    ofType {
                      name
                      kind
                    }
                  }
                }
                type {
                  name
                  kind
                  ofType {
                    name
                    kind
                  }
                }
              }
            }
          }
        }
      `;

      try {
        const data = await fetchGraphQL(query, {});
        const operations = data.__schema.queryType.fields;

        // Map operations with basic info
        const operationsWithBasicInfo = operations.map(op => {
          const returnType = getTypeInfo(op.type);
          const returnTypeName = getBaseTypeName(op.type);

          return {
            name: op.name,
            description: op.description,
            arguments: op.args.map(arg => ({
              name: arg.name,
              description: arg.description,
              type: getTypeInfo(arg.type),
              required: arg.type.kind === 'NON_NULL'
            })),
            returnType: returnType,
            returnTypeName: returnTypeName,
            returnFields: [] // Will be populated in next step
          };
        });

        // Now fetch fields for each unique return type
        console.log('üìã Fetching return type details...');
        const uniqueReturnTypes = [...new Set(operationsWithBasicInfo.map(op => op.returnTypeName))];
        const typeFieldsMap = {};

        for (const typeName of uniqueReturnTypes) {
          if (!typeName || typeName === 'Unknown') continue;

          try {
            const fields = await fetchTypeFields(typeName);
            typeFieldsMap[typeName] = fields;
            console.log(`‚úÖ Fetched fields for ${typeName}: ${fields.length} fields`);
          } catch (error) {
            console.warn(`‚ö†Ô∏è Could not fetch fields for ${typeName}:`, error.message);
            typeFieldsMap[typeName] = [];
          }

          // Small delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 50));
        }

        // Populate return fields
        discoveredSchema.queryOperations = operationsWithBasicInfo.map(op => ({
          ...op,
          returnFields: typeFieldsMap[op.returnTypeName] || []
        }));

        displayQueryOperations(discoveredSchema.queryOperations);
        return true;
      } catch (error) {
        console.error('Error discovering query operations:', error);
        document.getElementById('operationsList').innerHTML = `
          <div class="error">‚ùå Error: ${error.message}<br><br>
          <small>This may be due to GraphQL introspection depth limits. Basic operation info will still be available.</small></div>
        `;
        return false;
      }
    }

    function getBaseTypeName(type) {
      // Navigate through NON_NULL and LIST wrappers to get the base type name
      let actualType = type;
      while (actualType && (actualType.kind === 'NON_NULL' || actualType.kind === 'LIST')) {
        actualType = actualType.ofType;
      }
      return actualType?.name || 'Unknown';
    }

    async function fetchTypeFields(typeName) {
      const query = `
        query {
          __type(name: "${typeName}") {
            name
            fields {
              name
              description
              args {
                name
                description
                type {
                  name
                  kind
                  ofType {
                    name
                    kind
                  }
                }
              }
              type {
                name
                kind
                ofType {
                  name
                  kind
                }
              }
            }
          }
        }
      `;

      try {
        const data = await fetchGraphQL(query, {});
        if (!data.__type || !data.__type.fields) {
          return [];
        }

        return data.__type.fields.map(field => ({
          name: field.name,
          description: field.description,
          type: getTypeInfo(field.type),
          arguments: field.args ? field.args.map(arg => ({
            name: arg.name,
            description: arg.description,
            type: getTypeInfo(arg.type),
            required: arg.type.kind === 'NON_NULL'
          })) : []
        }));
      } catch (error) {
        console.error(`Error fetching fields for ${typeName}:`, error);
        return [];
      }
    }

    function getTypeInfo(type) {
      if (!type) return 'Unknown';

      if (type.kind === 'NON_NULL') {
        return getTypeInfo(type.ofType) + '!';
      } else if (type.kind === 'LIST') {
        return '[' + getTypeInfo(type.ofType) + ']';
      } else {
        return type.name || 'Unknown';
      }
    }

    function displayQueryOperations(operations) {
      const container = document.getElementById('operationsList');

      const html = `
        <div class="query-operations">
          <h4>Available Query Operations (${operations.length})</h4>
          <p style="color: #9ca3af; font-size: 13px; margin-top: 8px;">
            Click on an operation to see details. All operations are included in the downloaded schema JSON.
          </p>
          ${operations.map((op, idx) => `
            <details class="operation" style="cursor: pointer; margin-bottom: 12px;">
              <summary style="font-weight: bold; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                <strong style="color: #00d9ff;">${op.name}</strong>
                <span style="color: #9ca3af; font-size: 12px; margin-left: 8px;">‚Üí ${op.returnType}</span>
              </summary>
              <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; margin-top: 4px;">
                ${op.description ? `
                  <div style="color: #b084ff; margin-bottom: 12px; font-size: 13px;">
                    üìù ${op.description}
                  </div>
                ` : ''}

                ${op.arguments && op.arguments.length > 0 ? `
                  <div style="margin-bottom: 12px;">
                    <h5 style="color: #fbbf24; font-size: 13px; margin: 0 0 8px 0;">Arguments:</h5>
                    ${op.arguments.map(arg => `
                      <div style="margin-bottom: 6px; padding: 6px; background: rgba(251, 191, 36, 0.1); border-radius: 4px;">
                        <span class="field-tag tag">${arg.name}</span>
                        <span style="color: #9ca3af; font-size: 11px;">: ${arg.type}</span>
                        ${arg.required ? '<span style="color: #ef4444; font-size: 10px; margin-left: 4px;">REQUIRED</span>' : ''}
                        ${arg.description ? `<br><span style="color: #9ca3af; font-size: 11px; margin-left: 4px;">${arg.description}</span>` : ''}
                      </div>
                    `).join('')}
                  </div>
                ` : '<p style="color: #6b7280; font-size: 12px;">No arguments</p>'}

                ${op.returnFields && op.returnFields.length > 0 ? `
                  <div style="margin-bottom: 12px;">
                    <h5 style="color: #4ade80; font-size: 13px; margin: 0 0 8px 0;">Available Return Fields (${op.returnFields.length}):</h5>
                    <div style="background: rgba(74, 222, 128, 0.05); padding: 8px; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                      ${op.returnFields.map(field => `
                        <div style="margin-bottom: 8px; padding: 6px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">
                          <div>
                            <span class="field-tag property">${field.name}</span>
                            ${field.arguments && field.arguments.length > 0 ? `<span style="color: #fbbf24; font-size: 10px;">(${field.arguments.length} args)</span>` : ''}
                            <span style="color: #9ca3af; font-size: 11px;">: ${field.type}</span>
                          </div>
                          ${field.description ? `<div style="color: #6b7280; font-size: 11px; margin: 4px 0;">${field.description}</div>` : ''}
                          ${field.arguments && field.arguments.length > 0 ? `
                            <details style="margin-top: 4px;">
                              <summary style="cursor: pointer; color: #fbbf24; font-size: 11px;">Show arguments (${field.arguments.length})</summary>
                              <div style="margin-top: 4px; padding-left: 8px; border-left: 2px solid rgba(251, 191, 36, 0.3);">
                                ${field.arguments.map(arg => `
                                  <div style="margin: 4px 0; font-size: 11px;">
                                    <span style="color: #fbbf24;">${arg.name}</span>
                                    <span style="color: #9ca3af;">: ${arg.type}</span>
                                    ${arg.required ? '<span style="color: #ef4444; font-size: 9px;"> REQUIRED</span>' : ''}
                                    ${arg.description ? `<br><span style="color: #6b7280; font-size: 10px;">${arg.description}</span>` : ''}
                                  </div>
                                `).join('')}
                              </div>
                            </details>
                          ` : ''}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                  <h5 style="color: #a855f7; font-size: 12px; margin: 0 0 6px 0;">Example Query:</h5>
                  <pre style="background: rgba(0, 0, 0, 0.5); padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 11px; color: #e0e0e0; margin: 0;">query {
  ${op.name}${op.arguments.length > 0 ? `(
    ${op.arguments.slice(0, 3).map(arg => `${arg.name}: ${arg.type.includes('String') ? '"value"' : arg.type.includes('Int') ? '100' : arg.type.includes('Boolean') ? 'true' : 'null'}`).join('\n    ')}${op.arguments.length > 3 ? '\n    # ... more arguments' : ''}
  )` : ''} {
    ${op.returnFields && op.returnFields.length > 0 ? op.returnFields.slice(0, 5).map(f => {
      if (f.arguments && f.arguments.length > 0) {
        const exampleArgs = f.arguments.slice(0, 2).map(arg =>
          `${arg.name}: ${arg.type.includes('String') ? '"value"' : arg.type.includes('Int') ? '10' : arg.type.includes('Boolean') ? 'true' : 'null'}`
        ).join(', ');
        return `${f.name}(${exampleArgs}${f.arguments.length > 2 ? ', ...' : ''})`;
      }
      return f.name;
    }).join('\n    ') : '# No fields discovered'}${op.returnFields && op.returnFields.length > 5 ? '\n    # ... ' + (op.returnFields.length - 5) + ' more fields' : ''}
  }
}</pre>
                  <p style="color: #6b7280; font-size: 10px; margin: 8px 0 0 0;">
                    üí° Click "Show arguments" on fields above to see what parameters each field accepts
                  </p>
                </div>
              </div>
            </details>
          `).join('')}
        </div>
      `;

      container.innerHTML = html;
      document.getElementById('queryOperations').style.display = 'block';
    }

    async function fetchEntityTypeSample(entityTypeName) {
      const query = `
        query GetSampleEntities($first: Int!, $entityType: [String!]) {
          entityQuery {
            queryEntities(
              first: $first
              entityType: $entityType
            ) {
              totalCount
              entities {
                entityId
                entityName
                entityType
                tags {
                  key
                  value
                }
                properties {
                  name
                  value
                }
                namespaces {
                  name
                  properties {
                    name
                    value
                  }
                }
              }
            }
          }
        }
      `;

      const variables = {
        first: 5,
        entityType: [entityTypeName]
      };

      try {
        const data = await fetchGraphQL(query, variables);
        const result = data.entityQuery.queryEntities;

        if (result.totalCount > 0) {
          return {
            totalCount: result.totalCount,
            sampleEntities: result.entities
          };
        }
        return null;
      } catch (error) {
        console.error(`Error fetching ${entityTypeName}:`, error);
        return null;
      }
    }

    async function discoverAllEntityTypes() {
      document.getElementById('discoveryProgress').style.display = 'block';
      const total = COMMON_ENTITY_TYPES.length;
      let completed = 0;

      for (const entityTypeInfo of COMMON_ENTITY_TYPES) {
        const { name, description } = entityTypeInfo;

        document.getElementById('progressText').textContent =
          `Checking ${name}... (${completed + 1}/${total})`;

        const sampleData = await fetchEntityTypeSample(name);

        if (sampleData) {
          // Extract field information from sample data
          const fields = extractFieldsFromSamples(sampleData.sampleEntities);

          discoveredSchema.entityTypes.push({
            name: name,
            description: description,
            totalCount: sampleData.totalCount,
            sampleData: sampleData,
            fields: fields
          });

          console.log(`‚úÖ Found ${name}: ${sampleData.totalCount} entities`);
        } else {
          // Include entity type even if no data, with minimal field structure
          discoveredSchema.entityTypes.push({
            name: name,
            description: description,
            totalCount: 0,
            sampleData: null,
            fields: {
              basic: ['entityId', 'entityName', 'entityType'],
              tags: [],
              properties: [],
              namespaces: {}
            }
          });

          console.log(`‚ö†Ô∏è Included ${name}: No entities found (available for selection but no data)`);
        }

        completed++;
        const progress = (completed / total) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;

        // Small delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      displayResults();
    }

    function extractFieldsFromSamples(entities) {
      const fields = {
        basic: new Set(),
        tags: new Set(),
        properties: new Set(),
        namespaces: {}
      };

      entities.forEach(entity => {
        // Basic fields
        Object.keys(entity).forEach(key => {
          if (!['tags', 'properties', 'namespaces'].includes(key)) {
            fields.basic.add(key);
          }
        });

        // Tags
        if (entity.tags) {
          entity.tags.forEach(tag => fields.tags.add(tag.key));
        }

        // Properties
        if (entity.properties) {
          entity.properties.forEach(prop => fields.properties.add(prop.name));
        }

        // Namespaces
        if (entity.namespaces) {
          entity.namespaces.forEach(ns => {
            if (!fields.namespaces[ns.name]) {
              fields.namespaces[ns.name] = new Set();
            }
            if (ns.properties) {
              ns.properties.forEach(prop => {
                fields.namespaces[ns.name].add(prop.name);
              });
            }
          });
        }
      });

      // Convert Sets to Arrays for JSON serialization
      return {
        basic: Array.from(fields.basic),
        tags: Array.from(fields.tags),
        properties: Array.from(fields.properties),
        namespaces: Object.fromEntries(
          Object.entries(fields.namespaces).map(([ns, props]) => [ns, Array.from(props)])
        )
      };
    }

    function displayResults() {
      const entityTypes = discoveredSchema.entityTypes;
      document.getElementById('entityCount').textContent = entityTypes.length;

      const container = document.getElementById('entityList');

      if (entityTypes.length === 0) {
        container.innerHTML = '<div class="error">No entity types with data found.</div>';
        return;
      }

      const html = entityTypes.map(et => {
        const hasData = et.totalCount > 0;
        const borderColor = hasData ? '#00d9ff' : '#6b7280';
        const noDataBadge = hasData ? '' : '<span style="background: rgba(107, 114, 128, 0.3); color: #9ca3af; padding: 4px 12px; border-radius: 12px; font-size: 11px; margin-left: 12px;">NO DATA</span>';

        return `
        <div class="entity-card" style="border-left-color: ${borderColor}; ${hasData ? '' : 'opacity: 0.7;'}">
          <h3>${et.name}${noDataBadge}</h3>
          <p style="color: #9ca3af; margin: 8px 0;">${et.description}</p>

          <div class="entity-stats">
            <div class="stat">
              <div class="stat-label">Total Entities</div>
              <div class="stat-value">${et.totalCount.toLocaleString()}</div>
            </div>
            ${hasData ? `
            <div class="stat">
              <div class="stat-label">Sample Size</div>
              <div class="stat-value">${et.sampleData.sampleEntities.length}</div>
            </div>
            ` : ''}
            <div class="stat">
              <div class="stat-label">Basic Fields</div>
              <div class="stat-value">${et.fields.basic.length}</div>
            </div>
            <div class="stat">
              <div class="stat-label">Tags</div>
              <div class="stat-value">${et.fields.tags.length}</div>
            </div>
            <div class="stat">
              <div class="stat-label">Properties</div>
              <div class="stat-value">${et.fields.properties.length}</div>
            </div>
            <div class="stat">
              <div class="stat-label">Namespaces</div>
              <div class="stat-value">${Object.keys(et.fields.namespaces).length}</div>
            </div>
          </div>

          <div class="field-list">
            ${et.fields.basic.length > 0 ? `
              <div class="field-category">
                <h4>Basic Fields</h4>
                ${et.fields.basic.map(f => `<span class="field-tag basic">${f}</span>`).join('')}
              </div>
            ` : ''}

            ${et.fields.tags.length > 0 ? `
              <div class="field-category">
                <h4>Tags</h4>
                ${et.fields.tags.map(f => `<span class="field-tag tag">${f}</span>`).join('')}
              </div>
            ` : ''}

            ${et.fields.properties.length > 0 ? `
              <div class="field-category">
                <h4>Properties</h4>
                ${et.fields.properties.map(f => `<span class="field-tag property">${f}</span>`).join('')}
              </div>
            ` : ''}

            ${Object.keys(et.fields.namespaces).length > 0 ? `
              <div class="field-category">
                <h4>Namespaces</h4>
                ${Object.entries(et.fields.namespaces).map(([ns, props]) => `
                  <div style="margin-bottom: 8px;">
                    <strong style="color: #a855f7; font-size: 13px;">${ns}:</strong><br>
                    ${props.map(p => `<span class="field-tag namespace">${p}</span>`).join('')}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        </div>
      `;
      }).join('');

      container.innerHTML = html;
      document.getElementById('results').style.display = 'block';

      // Enable download buttons
      document.getElementById('downloadBtn').disabled = false;
      document.getElementById('copyBtn').disabled = false;
    }

    async function main() {
      try {
        // Step 1: Discover query operations
        const success = await discoverQueryOperations();

        if (!success) {
          document.getElementById('loading').innerHTML =
            '<span class="error">‚ùå Failed to discover query operations</span>';
          return;
        }

        // Step 2: Discover all entity types
        await discoverAllEntityTypes();

        // Done
        document.getElementById('loading').style.display = 'none';
        console.log('‚úÖ Discovery complete!', discoveredSchema);

      } catch (error) {
        document.getElementById('loading').innerHTML =
          `<span class="error">‚ùå Error: ${error.message}</span>`;
        document.getElementById('loading').style.backgroundColor = '#cb253e';
      }
    }

    // Download JSON
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const json = JSON.stringify(discoveredSchema, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tanzu-platform-schema-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Copy to clipboard
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const json = JSON.stringify(discoveredSchema, null, 2);
      await navigator.clipboard.writeText(json);
      alert('Schema copied to clipboard!');
    });

    // Receive API config from parent window
    function receiveHubToken(event) {
      console.log('üì® Received message:', event.data);

      // The message can have config in either data.data or data.config
      const config = event?.data?.data || event?.data?.config;

      if (event?.data?.type === 'apiConfig' && config?.token?.length && config?.endPoint?.length) {
        console.log('‚úÖ API config received:', { endpoint: config.endPoint, hasToken: !!config.token });
        bearerToken = config?.token;
        serviceUrl = config?.endPoint;
        main();
      } else {
        console.log('‚ö†Ô∏è Message received but not valid apiConfig:', event.data);
      }
    }

    console.log('üéØ Entity Discovery Report loaded, waiting for API config...');
    window.addEventListener('message', receiveHubToken, false);
  </script>
</body>
</html>
